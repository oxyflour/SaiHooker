<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=IE10" />
	<meta charset="utf-8" />
	<title>SaiHooker</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        a {
            color: #555;
            text-decoration: none;
        }
        a:hover {
            color: #999;
            text-decoration: underline;
        }
        input[type=file] {
            width: 0;
            height: 0;
            position: absolute;
            font-size: 150%;
        }
        .hidden {
            display: none;
        }
    </style>
	<!-- HTA tag does not work in IE Edge -->
	<HTA:Application
		id="Sai_Hooker_33895"
		applicationname="Sai Hooker"
		icon="sai.ico"
		innerborder="no"
		scroll="yes"
		selection="no"
		maximizebutton="no"
		contextmenu="no"
		sysmenu="yes"
		singleinstance="yes" />
</head>
<body>
	<object id="hooker" width="0" height="0" classid="clsid:8E1D1128-0685-4C1D-8475-916B2BDE241A"></object>
	<object id="wndutil" width="0" height="0" classid="clsid:4661BF20-A332-4ADA-9F20-1D6EAB5DADA3"></object>
    <div class="show-image hidden">
        <input id="img_file" type="file" />
        <a style="position:absolute;background-color:#eee;margin:3px" href="#" onclick="loadImage()">[ close ]</a>
        <img id="img" unselectable="on" onclick="toggleImageSize(this)" />
    </div>
    <div class="hide-image" style="margin:10px">
        <div class="show-error">
            <h3>Hook to SAI failed <small>(<span class="errno"></span>)</small></h3>
            <span>
                <input id="sai_file" type="file" />
                <a href="#" onclick="browseFile('#sai_file') && runFile('#sai_file');return false;">[ Browse ]</a>
            </span>
        </div>
        <form class="hide-error">
            <h4>
                <small><a href="#" onclick="$('#log').toggle();return false">[ see log ]</a></small>
                <small><a href="#" onclick="browseFile('#img_file') && loadImage('#img_file');return false">[ load image ]</a></small>
            </h4>
            <p><label><input class="auto-load" type="checkbox"
                    initvalue="hooker.GetSaiStatus('lock-touch')"
                    onclick="hooker.SetSaiStatus('lock-touch', this.checked ? '1' : '')" />Disable Touch</label></p>
            <p><label><input type="checkbox" value="16" onclick="simulateKey(this.value, this.checked)" />Shift</label></p>
            <p><label><input type="checkbox" value="17" onclick="simulateKey(this.value, this.checked)" />Ctrl</label></p>
            <p><label><input type="checkbox" value="18" onclick="simulateKey(this.value, this.checked)" />Alt</label></p>
        </form>
        <div id="log" style="display:none"></div>
    </div>
	<script src="jquery-1.8.0.min.js"></script>
	<script id="popup" type="text/xml" for="menu">
		<menu>
			<item text="Pen (&amp;N/l)" gst="l" key="n" />
			<item text="Eraser (&amp;E/r)" gst="r" key="e" />
			<item text="Move (&amp;M/d)" gst="d" key="m" />
			<item text="Straw (&amp;L/D)" gst="D" key="l" />
			<sep />
			<item text="Redu (&amp;R/du)" gst="du" key="^y" />
			<item text="Clear (&amp;D/dL)" gst="dL" key="d" />
			<item text="Flip (&amp;H/dl)" gst="dl" key="h" />
			<item text="Fill (C-F/dU)" gst="dU" key="^f" />
			<item text="Filter (&amp;O)" key="o" />
			<sep />
			<menu text="Select">
				<item text="SelNone (C-D/u)" gst="u" key="^d" />
				<item text="SelRect (&amp;Q/ul)" gst="ul" key="q" />
				<item text="SelFree (&amp;U/ur)" gst="ur" key="u" />
				<item text="SelPen (&amp;A/uD)" gst="uD" key="a" />
				<item text="SelEraser (&amp;S/uR)" gst="uR" key="s" />
				<item text="SelRegion (&amp;F/ud)" gst="ud" key="f" />
			</menu>
			<menu text="UI, File">
				<item text="TAB (Tab/U)" gst="U" key="{TAB}" />
				<item text="Fullscreen (F11/UD)" gst="UD" key="{F11}" />
				<item text="NextView (C-Tab/Ul)" key="^{TAB}" />
				<item text="PrevView (C-S-Tab/Ud)" key="^+{TAB}" />
				<sep />
				<item text="Open... (C-O/rl)" key="^o" />
				<item text="SaveAs... (C-S-S/rd)" key="^+s" />
				<item text="New... (C-N/rL)" key="^n" />
				<item text="Close (C-W/rD)" key="^w" />
			</menu>
			<menu text="Trans, Edit">
				<item text="Trans (C-T/RL)" key="^t" />
				<item text="Accept (Enter/Ru)" key="{ENTER}" />
				<item text="Cancel (Escape/Rl)" key="{ESCAPE}" />
				<sep />
				<item text="Cut (C-X/Lr)" key="^x" />
				<item text="Copy (C-C/Ld)" key="^c" />
				<item text="Past (C-V/LR)" key="^v" />
			</menu>
			<menu text="Pens, Mix">
				<item text="Mark (&amp;I/lr)" gst="lr" key="i" />
				<item text="Color (&amp;C/lu)" gst="lu" key="c" />
				<item text="Spray (&amp;B/ld)" gst="ld" key="b" />
				<item text="Pain (&amp;V/lU)" gst="lU" key="v" />
				<item text="Blur (&amp;J/lR)" gst="lR" key="j" />
				<sep />
				<item text="Size+ (&amp;]/L)" gst="L" key="]" />
				<item text="Size- (&amp;[/R)" gst="R" key="[" />
			</menu>
			<sep />
			<item text="Cancel" />
		</menu>
	</script>
    <script for="hooker" event="OnHookEvent(msg, wParam, lParam)">
        // pen events
        if (msg == 0) {
            // pen reversed
            if (wParam == 0 && lParam)
                hooker.SimulateKey('E'.charCodeAt(0), window.penReversed = !window.penReversed);
            // pen eraser
            else if (wParam == 1)
                ;
            // pen button
            else if (wParam == 2)
                ;
                logText('unknown pen event: (' + wParam.toString(16) + ', ' + lParam.toString(16) + ')');
        }
        // notify events
        else if (msg == 1) {
            var delta = lParam & 0x10000,
                index = lParam & 0xffff;
            if (wParam == 1)
                wscript.SendKeys(delta ? '{DEL}' : '{END}');
            else if (wParam == 2)
                wscript.SendKeys(delta ? '{PGUP}' : '{PGDN}');
            else if (wParam == 3)
                wscript.SendKeys(('nbvceas').charAt(index - 9));
            else if (wParam == 4)
                wscript.SendKeys(delta ? '{]}' : '{[}');
            else if (wParam == 21)
                wscript.SendKeys(delta ? '{PGDN}' : '{PGUP}');
            else if (wParam == 22)
                wscript.SendKeys(delta ? '{DEL}' : '{END}');
            else if (wParam == 23 || wParam == 24) {
                hooker.RegisterNotify(0, 'th-z', '0');
                hooker.RegisterNotify(0, 'th-r', '0');
                hooker.RegisterNotify(0, 'ms-x', '0');
                hooker.RegisterNotify(0, 'ms-y', '0');
                hooker.SimulateDragWith(0x20, false, false, false);
            }
            else
                logText('unknown notify: (' + wParam.toString(16) + ', ' + lParam.toString(16) + ')');
        }
        else
            logText('unknown message: ' + msg + ' (' + wParam.toString(16) + ', ' + lParam.toString(16) + ')');
    </script>
    <script for="hooker" event="OnMouseGesture(vec, key, x, y)">
        // left mouse button is down when the gesture ends
        if (key == 1) {
            ({
                '': function () {
                    hooker.SimulateDragWith(0x20, false, false, false);
                },
                u: function () {
                    hooker.RegisterNotify(1, 'ms-x', createSteps(15));
                    hooker.RegisterNotify(2, 'ms-y', createSteps(20));
                },
                l: function () {
                    hooker.RegisterNotify(3, 'ms-x', createSteps(30));
                    hooker.RegisterNotify(4, 'ms-y', createSteps(20));
                }
            }[vec] || function () {
                logText('unknown stroke: ' + vec);
            })();
        }
        // no buttons are down
        else {
            if (vec) {
                var item = $('#popup').data('doc').find('[gst=' + vec + ']');
                item.attr('key') ? wscript.SendKeys(item.attr('key')) :
                    logText('unknown gesture: ' + vec);
            }
            else {
                wscript.SendKeys('^z');
            }
        }
    </script>
    <script for="hooker" event="OnTouchGesture(num, key, x, y)">
        // fingers are on the surface and starting to move
        if (key == 1) {
            // pan with one finger
            if (num == 1) {
                hooker.SimulateDragWith(0x20, false, false, false);
            }
            // zoom/rotate with two fingers
            else if (num == 2) {
                hooker.RegisterNotify(21, 'th-z', createSteps(10, 0, 5));
                hooker.RegisterNotify(22, 'th-r', createSteps(10, 0, 5));
                hooker.RegisterNotify(23, 'ms-x', createSteps(80, 2));
                hooker.RegisterNotify(24, 'ms-y', createSteps(80, 2));
            }
            // move layer with three finger
            else if (num == 3) {
                hooker.SimulateDragWith(0, true, false, false);
            }
        }
        // fingers tap
        else {
            // one-finger tap
            if (num == 0) {
                var tapTick = Date.now();
                // double tap detection
                if (tapTick - window.tapTick < 200) {
                    /*
                    // ALT + Click
                    hooker.SimulateKey(18, true);
                    hooker.SimulateMouse(x, y, true);
                    hooker.SimulateMouse(x, y, 0);
                    hooker.SimulateKey(18, 0);
                    */
                    wscript.SendKeys('{HOME}');
                }
                window.tapTick = tapTick;
            }
            // two-finger tap
            else if (num == 1) {
                wscript.SendKeys('{TAB}');
            }
            // three-finger tap
            else if (num == 2) {
                wscript.SendKeys('{F11}');
            }
            // four-finger tap
            else if (num == 3) {
                // send WIN+D event
                hooker.SimulateKey(0x5b, true);
                wscript.SendKeys('d');
                hooker.SimulateKey(0x5b, 0);
            }
        }
    </script>
	<script>
	    function updateVisibility(name, value) {
            $(value ? '.show-'+name : '.hide-'+name).removeClass('hidden');
            $(value ? '.hide-'+name : '.show-'+name).addClass('hidden');
	    }
		function logText(t, c, a) {
			$('#log').prepend('<div class="'+c+'">'+t+'</div>');
		}
		function loadImage(fi) {
		    var path = $(fi).val();
		    if (path) {
		        $('#img').attr('src', path);
		        logText('loading image: ' + path);
		    }
		    updateVisibility('image', path);
		}
		function toggleImageSize(im) {
		    im = $(im);
		    var ww = $(window).width();
		    im.width() == ww ? im.width('auto') : im.width(ww);
		}
		function sendKeys(ks) {
			wndutil.ActiveSaiWindow();
			wscript.SendKeys(ks);
		}
		function simulateKey(vk, down) {
			wndutil.ActiveSaiWindow();
			hooker.SimulateKey(vk, down);
		}
		function createSteps(d, n, b) {
		    var ls = [], b = b || 0;
		    for (var i = 0; i < (n || 20); i++) {
		        b += d;
		        ls.push(b);
		        ls.push(-b);
		    }
		    return ls.sort(function (a, b) {
		        return a - b;
		    }).join(',');
		}
		function browseFile(fi) {
		    return $(fi).trigger('click').val();
		}
		function runFile(fi) {
		    var path = $(fi).val();
            if (path)
	            wscript.Run(path);
		}

		window.hooker = document.getElementById('hooker');
		window.wndutil = document.getElementById('wndutil');
		window.wscript = new ActiveXObject("WScript.Shell");

		window.ontimer = function () {
			var errno = hooker.Hook();
			$('.errno').text(errno);
		    updateVisibility('error', errno);
		}
		window.onload = function () {
			wndutil.SetupToolWindow(document.title);

			$('input[type=checkbox].auto-load').each(function(i, e) {
				var v = $(e).attr('initvalue');
				if (v) e.checked = eval(v);
			});
			$('select.auto-load').each(function(i, e) {
				var c = $(e).children('option'),
					v = $(e).attr('initvalue'),
					p = c.filter('[value="'+(v ? eval(v) : '')+'"]');
				(p[0] || c[0]).selected = true;
			});
			$('script[for=menu]').each(function (i, e) {
                var elem = $(e), doc = $(elem.html());
                doc.find('item').each(function(i, e) { $(e).attr('cid', i+1); })
                elem.data('doc', doc).data('xml', doc[0].outerHTML);
			});

            window.resizeTo(220, 260);
            window.ontimer();
            setInterval(window.ontimer, 2000)
		}
		window.onbeforeunload = function () {
			hooker.UnHook();
		}
	</script>
</body>
</html>
