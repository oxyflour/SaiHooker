<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=IE10" />
	<meta charset="utf-8" />
	<title>SaiHooker</title>
    <style>
        input[type=file] {
            width: 0;
            height: 0;
            position: absolute;
            font-size: 150%;
        }
    </style>
	<!-- HTA tag does not work in IE Edge -->
	<HTA:Application
		id="Sai_Hooker_33895"
		applicationname="Sai Hooker"
		icon="sai.ico"
		innerborder="no"
		scroll="yes"
		selection="no"
		maximizebutton="no"
		contextmenu="no"
		sysmenu="yes"
		singleinstance="yes" />
</head>
<body>
	<object id="hooker" width="0" height="0" classid="clsid:8E1D1128-0685-4C1D-8475-916B2BDE241A"></object>
	<object id="wndutil" width="0" height="0" classid="clsid:4661BF20-A332-4ADA-9F20-1D6EAB5DADA3"></object>
    <div class="show-error">
        <h3>Hook to SAI failed <small>(<span class="errno"></span>)</small></h3>
        <span>
            <input type="file" onchange="runSai()" />
            <a href="javascript:void(null)" onclick="browseSai();return false;">Browse</a>
        </span>
        &nbsp;
        <a href="javascript:void(null)" onclick="runSai();return false;">Run</a>
    </div>
    <form class="hide-error">
        <h3>SaiHooker Toggles</h3>
        <p><label><input class="auto-load" type="checkbox"
                initvalue="hooker.DisableTouch(-1)"
                onclick="hooker.DisableTouch(this.checked ? 1 : 0)" />Disable Touch</label></p>
        <p><label><input type="checkbox" value="16" onclick="simulateKey(this.value, this.checked)" />Shift</label></p>
        <p><label><input type="checkbox" value="17" onclick="simulateKey(this.value, this.checked)" />Ctrl</label></p>
        <p><label><input type="checkbox" value="18" onclick="simulateKey(this.value, this.checked)" />Alt</label></p>
    </form>
	<div id="log"></div>
	<script src="jquery-1.8.0.min.js"></script>
	<script id="popup" type="text/xml">
		<menu>
			<item text="Pen (&amp;N/l)" gst="l" key="n" />
			<item text="Eraser (&amp;E/r)" gst="r" key="e" />
			<item text="Move (&amp;M/d)" gst="d" key="m" />
			<item text="Straw (&amp;L/D)" gst="D" key="l" />
			<sep />
			<item text="Redu (&amp;R/du)" gst="du" key="^y" />
			<item text="Clear (&amp;D/dL)" gst="dL" key="d" />
			<item text="Flip (&amp;H/dl)" gst="dl" key="h" />
			<item text="Fill (C-F/dU)" gst="dU" key="^f" />
			<item text="Filter (&amp;O)" key="o" />
			<sep />
			<menu text="Select">
				<item text="SelNone (C-D/u)" gst="u" key="^d" />
				<item text="SelRect (&amp;Q/ul)" gst="ul" key="q" />
				<item text="SelFree (&amp;U/ur)" gst="ur" key="u" />
				<item text="SelPen (&amp;A/uD)" gst="uD" key="a" />
				<item text="SelEraser (&amp;S/uR)" gst="uR" key="s" />
				<item text="SelRegion (&amp;F/ud)" gst="ud" key="f" />
			</menu>
			<menu text="UI, File">
				<item text="TAB (Tab/U)" gst="U" key="{TAB}" />
				<item text="Fullscreen (F11/UD)" gst="UD" key="{F11}" />
				<item text="NextView (C-Tab/Ul)" key="^{TAB}" />
				<item text="PrevView (C-S-Tab/Ud)" key="^+{TAB}" />
				<sep />
				<item text="Open... (C-O/rl)" key="^o" />
				<item text="SaveAs... (C-S-S/rd)" key="^+s" />
				<item text="New... (C-N/rL)" key="^n" />
				<item text="Close (C-W/rD)" key="^w" />
			</menu>
			<menu text="Trans, Edit">
				<item text="Trans (C-T/RL)" key="^t" />
				<item text="Accept (Enter/Ru)" key="{ENTER}" />
				<item text="Cancel (Escape/Rl)" key="{ESCAPE}" />
				<sep />
				<item text="Cut (C-X/Lr)" key="^x" />
				<item text="Copy (C-C/Ld)" key="^c" />
				<item text="Past (C-V/LR)" key="^v" />
			</menu>
			<menu text="Pens, Mix">
				<item text="Mark (&amp;I/lr)" gst="lr" key="i" />
				<item text="Color (&amp;C/lu)" gst="lu" key="c" />
				<item text="Spray (&amp;B/ld)" gst="ld" key="b" />
				<item text="Pain (&amp;V/lU)" gst="lU" key="v" />
				<item text="Blur (&amp;J/lR)" gst="lR" key="j" />
				<sep />
				<item text="Size+ (&amp;]/L)" gst="L" key="]" />
				<item text="Size- (&amp;[/R)" gst="R" key="[" />
			</menu>
			<sep />
			<item text="Cancel" />
		</menu>
	</script>
    <script for="hooker" event="OnHookEvent(msg, wParam, lParam)">
        if (msg == 1)
            wscript.SendKeys(wParam ? '{DEL}' : '{END}');
        else if (msg == 2)
            wscript.SendKeys(wParam ? '{PGUP}' : '{PGDN}');
        else if (msg == 3)
            wscript.SendKeys(('nbvceas').charAt(lParam - 9));
        else if (msg == 4)
            wscript.SendKeys(wParam ? '{]}' : '{[}');
        else if (msg == 21)
            wscript.SendKeys(wParam ? '{PGDN}' : '{PGUP}');
        else if (msg == 22)
            wscript.SendKeys(wParam ? '{DEL}' : '{END}');
        else
            logText('unknown event: ' + msg + ' (' + wParam + ', ' + lParam + ')');
        return false; // IE10 will not be sactisfied if you do nothing
    </script>
    <script for="hooker" event="OnMouseGesture(vec, key, x, y)">
        // left mouse button is down
        if (key == 1) {
            ({
                '': function () {
                    hooker.SimulateDragWith(0x20, false, false, false);
                    /*
                    hooker.SimulateKey(18, true);
                    hooker.SimulateMouse(0, 0, true);
                    hooker.SimulateMouse(0, 0, 0);
                    hooker.SimulateKey(18, 0);
                    */
                },
                u: function () {
                    hooker.RegisterNotify(1, 'ms-x', createSteps(15));
                    hooker.RegisterNotify(2, 'ms-y', createSteps(20));
                },
                l: function () {
                    hooker.RegisterNotify(3, 'ms-x', createSteps(30));
                    hooker.RegisterNotify(4, 'ms-y', createSteps(20));
                }
            }[vec] || function () {
                logText('unknown stroke: ' + vec);
            })();
        }
        // no button down
        else {
            if (vec) {
                var item = $('#popup').data('doc').find('[gst=' + vec + ']');
                item.attr('key') ? wscript.SendKeys(item.attr('key')) :
                    logText('unknown gesture: ' + vec);
            }
            else {
                wscript.SendKeys('^z');
            }
        }
        return false;
    </script>
    <script for="hooker" event="OnTouchGesture(num, key, x, y)">
        if (key == 1) {
            if (num == 1) {
                hooker.SimulateDragWith(0x20, false, false, false);
            }
            else if (num == 2) {
                hooker.RegisterNotify(21, 'th-z', createSteps(10, 20, 5));
                hooker.RegisterNotify(22, 'th-r', createSteps(10, 20, 5));
            }
        }
        else {
            // one finger tap
            if (num == 0) {
                var tapTick = Date.now();
                // double tap detection
                if (tapTick - window.tapTick < 200) {
                    // ALT + Click
                    hooker.SimulateKey(18, true);
                    hooker.SimulateMouse(x, y, true);
                    hooker.SimulateMouse(x, y, 0);
                    hooker.SimulateKey(18, 0);
                }
                window.tapTick = tapTick;
            }
                // two finger tap
            else if (num == 1) {
                var pop = $('#popup'),
                    id = wndutil.PopupMenu(pop.data('xml'), x, y),
                    item = pop.data('doc').find('[cid=' + id + ']');
                wndutil.ActiveSaiWindow();
                item.attr('key') && wscript.SendKeys(item.attr('key'));
            }
                // three finger tap
            else if (num == 2) {
                wscript.SendKeys('{F11}');
            }
                // four finger tap
            else if (num == 3) {
                // send WIN+D event
                hooker.SimulateKey(0x5b, true);
                wscript.SendKeys('d');
                hooker.SimulateKey(0x5b, 0);
            }
        }
        return false;
    </script>
	<script>
		function logText(t, c, a) {
			$('#log').prepend('<div class="'+c+'">'+t+'</div>');
		}
		function sendKeys(ks) {
			wndutil.ActiveSaiWindow();
			wscript.SendKeys(ks);
		}
		function simulateKey(vk, down) {
			wndutil.ActiveSaiWindow();
			hooker.SimulateKey(vk, down);
		}
		function createSteps(d, n, b) {
		    var ls = [], b = b || 0;
		    for (var i = 0; i < (n || 10); i++) {
		        b += d;
		        ls.push(b);
		        ls.push(-b);
		    }
		    return ls.sort(function (a, b) {
		        return a - b;
		    }).join(',');
		}
		function browseSai() {
		    $('input[type=file]').trigger('click');
		}
		function runSai() {
		    var path = $('input[type=file]').val();
	        path && wscript.Run(path);
		}

		window.hooker = document.getElementById('hooker');
		window.wndutil = document.getElementById('wndutil');
		window.wscript = new ActiveXObject("WScript.Shell");

		window.onload = function () {
			wndutil.SetupToolWindow(document.title);

			$('input[type=checkbox].auto-load').each(function(i, e) {
				var v = $(e).attr('initvalue');
				if (v) e.checked = eval(v);
			});
			$('select.auto-load').each(function(i, e) {
				var c = $(e).children('option'),
					v = $(e).attr('initvalue'),
					p = c.filter('[value="'+(v ? eval(v) : '')+'"]');
				(p[0] || c[0]).selected = true;
			});

			// prepare xml text for PopupMenu
			var pop = $('#popup'), doc = $(pop.html());
			doc.find('item').each(function(i, e) { $(e).attr('cid', i+1); })
			pop.data('doc', doc).data('xml', doc[0].outerHTML);
		}
		window.onbeforeunload = function () {
			hooker.UnHook();
		}
		window.ontimer = function () {
			var errno = hooker.Hook();
			$('.errno').text(errno);
			$(errno ? '.show-error' : '.hide-error').show();
			$(errno ? '.hide-error' : '.show-error').hide();
		}

		window.resizeTo(240, 300);
		window.ontimer();
		setInterval(window.ontimer, 2000)
	</script>
</body>
</html>
